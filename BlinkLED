#include "Adafruit_LEDBackpack.h"
#include "Adafruit_GFX.h"
#include <Wire.h>

#define red 3
#define green 6
#define blue 5
#define delaya 2

Adafruit_7segment matrix = Adafruit_7segment();
int g_iR = 0;
int g_iG = 0;
int g_iB = 0;
int g_iRratio = 2.56;
int g_iGratio = 2.56;
int g_iBratio = 2.56;
int potPin = 2;
int potVal = 0;
int buttonPin = 3;
int g_lightColor;
int lightPattern = 0; //Light Pattern
float g_redPercent = 0;
float g_greenPercent = 0;
float g_bluePercent = 0;
unsigned long g_bpm = 120; //Tempo BPM
unsigned long g_bpmMS = 60000 / g_bpm;
unsigned long timeMS = 0;

//*********************************
void setup()
{
  Serial.begin(9600);
  delay(150);
  matrix.print(g_bpm);
  attachInterrupt(digitalPinToInterrupt(buttonPin), beatTimer, RISING);
  pinMode(red, OUTPUT);
  pinMode(green, OUTPUT);
  pinMode(blue, OUTPUT);
} 

//*********************************
void loop()
{
  //Serial.println(g_bpm);
  //Serial.println(millis());
  
  //potVal = analogRead(0); //read pin 2 analog value from pot each loop
  //Serial.println(potVal);
  //Serial.println(g_bpm);
  
  //matrix.writeDigitNum(
  
  //g_bpm = 115 + (potVal / (1023 / 20)); //40bpm spread starting at 100 bpm
  
  //Serial.println(lightPattern);
  if (lightPattern == 0)
  {
    //Serial.println("Running light pattern 1");
    lightPattern1();
  }
  else if (lightPattern == 1)
  {
    //Serial.println("Running light pattern 2");
    lightPattern2();
  }
  else if (lightPattern == 2)
  {
    //Serial.println("Running light pattern 3");
    lightPattern3();
  }
  else if (lightPattern == 3)
  {
    //Serial.println("Running light pattern 4");
    lightPattern4();
  }
  else if (lightPattern == 4)
  {
    //Serial.println("Running light pattern 5");
    lightPattern5();
  }
}
//*********************************
void lightPattern1()
{
  changeColor();
  unsigned long rampValue = 0;
  delay(1);
  timeMS = millis();
  //g_bpm = rotaryPotBpm(analogRead(0));
  g_bpmMS = (60000 / g_bpm) - 2  ; //-1 for delay adjustment during loops
  //Serial.println(g_bpm);
  while ((millis() - timeMS) < (g_bpmMS / 2))
  {
    rampValue = rampValue + (1200 / (g_bpmMS / 2));
    delay(5);
    //Serial.println(rampValue);
    //
    analogWrite(red,rampValue * g_redPercent);
    analogWrite(green,rampValue * g_greenPercent);
    analogWrite(blue,rampValue * g_bluePercent);
    //
    matrix.print(rampValue);
  }
  //beatTimer();
  timeMS = millis();
  while ((millis() - timeMS) < (g_bpmMS / 2))
  {
    rampValue = rampValue - (1200 / (g_bpmMS / 2));
    delay(5);
    //Serial.println(rampValue);
    //
    analogWrite(red,rampValue * g_redPercent);
    analogWrite(green,rampValue * g_greenPercent);
    analogWrite(blue,rampValue * g_bluePercent);
    //
    matrix.print(rampValue);
  }
}

//*********************************
void lightPattern2()
{
  changeColor();
  delay(1);
  //g_bpm = rotaryPotBpm(analogRead(0));
  g_bpmMS = (60000 / g_bpm) - 3  ; //-1 for delay adjustment during loops
  //Serial.println(g_bpm); 
  timeMS = millis();
  while ((millis() - timeMS) < (g_bpmMS / 10))
  {
    //delay(6);
    analogWrite(red,1200 * g_redPercent);
    analogWrite(green,1200 * g_greenPercent);
    analogWrite(blue,1200 * g_bluePercent);
  }
  timeMS = millis();
  while ((millis() - timeMS) < (g_bpmMS / 1.1))
  {
    //delay(6);
    analogWrite(red,0);
    analogWrite(green,0);
    analogWrite(blue,0);
  } 
}
//*********************************
void lightPattern3()
{
  // Slow light blend between colors
  // Constant slow BPM 70 bpm?
  // colors: purple, blue, pink, 
}
//*********************************
void lightPattern4()
{
  
}
//*********************************
void lightPattern5()
{
  
}

//*********************************
void button1push()
{
lightPattern = lightPattern + 1;
if (lightPattern = 4)
{ 
  lightPattern = 0; 
}
//Serial.println("lightPattern = " + lightPattern);
}

//*********************************
void button2push()
{

}

//*********************************
int rotaryPotBpm(int inputVal)
{
  //Serial.println(inputVal);
  if(inputVal < 51)
  { g_bpm = 115; }
  else if(inputVal < 102)
  { g_bpm = 116; }
  else if(inputVal < 153)
  { g_bpm = 117; }
  else if(inputVal < 205)
  { g_bpm = 118; }
  else if(inputVal < 256)
  { g_bpm = 119; }
  else if(inputVal < 307)
  { g_bpm = 120; }
  else if(inputVal < 358)
  { g_bpm = 121; }
  else if(inputVal < 409)
  { g_bpm = 122; }
  else if(inputVal < 460)
  { g_bpm = 123; }
  else if(inputVal < 512)
  { g_bpm = 124; }
  else if(inputVal < 563)
  { g_bpm = 125; }
  else if(inputVal < 614)
  { g_bpm = 126; }
  else if(inputVal < 665)
  { g_bpm = 127; }
  else if(inputVal < 716)
  { g_bpm = 128; }
  else if(inputVal < 767)
  { g_bpm = 129; }
  else if(inputVal < 818)
  { g_bpm = 130; }
  else if(inputVal < 870)
  { g_bpm = 131; }
  else if(inputVal < 921)
  { g_bpm = 132; }
  else if(inputVal < 972)
  { g_bpm = 133; }
  else if(inputVal < 1023)
  { g_bpm = 134; }
  else if(inputVal < 1023)
  { g_bpm = 134; }
  //Serial.println(g_bpm);
  return g_bpm;
}

//*********************************
void beatTimer()
{
  digitalWrite(13, digitalRead(13) ^ 1);
  g_bpm = g_bpm + 0;
  //Serial.println(g_bpm);
}
//*********************************
void changeColor()
{
g_lightColor = g_lightColor + 1;
if(g_lightColor == 4)
  {
    g_lightColor = 0;
  }
  //
  //
if(g_lightColor == 0)
  {
    //red
    g_redPercent = 1;
    g_greenPercent = 0;
    g_bluePercent = 0;
  }
else if(g_lightColor == 1)
  {
    //purple
    g_redPercent = 1;
    g_greenPercent = 0;
    g_bluePercent = .6 ;
  }
else if(g_lightColor == 2)
  {
    //blue
    g_redPercent = 0;
    g_greenPercent = 0;
    g_bluePercent = 1;
  }
  else if(g_lightColor == 3)
  {
    //blue
    g_redPercent = 0;
    g_greenPercent = 1;
    g_bluePercent = 1;
  }
  /*
  Serial.println(g_redPercent);
  Serial.println(g_greenPercent);
  Serial.println(g_bluePercent);*/
}
